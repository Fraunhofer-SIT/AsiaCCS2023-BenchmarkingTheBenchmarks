package de.fraunhofer.sit.runexploits;

import java.net.URI;
import java.nio.file.DirectoryStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;

import soot.PackManager;
import soot.RefType;
import soot.Scene;
import soot.SootClass;
import soot.options.Options;

public class MigrateServletsApp {

	public static void main(String[] args) throws Throwable {
		Options.v().set_allow_phantom_refs(true);
		Options.v().set_process_dir(Arrays.asList("../WebRoot/WEB-INF/classes"));
		Options.v().set_output_format(Options.output_format_class);
		Options.v().set_output_dir("../WebRoot-Jakarta/WEB-INF/classes");

		Scene.v().loadNecessaryClasses();
		PackManager.v().runPacks();
		convert();
		PackManager.v().writeOutput();

	}

	private static void convert() {
		for (SootClass c : Scene.v().getClasses()) {
			String renamed = rename(c.getName());
			if (renamed != null) {
				c.getType().setClassName(renamed);
				RefType.v(renamed).setSootClass(c);
				c.setName(renamed);
			}
		}
		PackManager.v().writeOutput();
		System.out.println();
	}

	private static String rename(String name) {
		if (name.startsWith("javax.servlet."))
			return "jakarta.servlet." + name.substring("javax.servlet.".length());
		return null;
	}

}
