package de.fraunhofer.sit.runexploits;

import java.io.File;
import java.io.PrintWriter;
import java.lang.annotation.Annotation;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.Collection;

import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.filefilter.TrueFileFilter;

public class GenerateWebXMLApp {

	public static void main(String[] args) throws Throwable {
		generateWebXML();
	}

	private static void generateWebXML() throws Throwable {
		String header = "<web-app xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\"\n"
				+ "         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n"
				+ "         xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee\n"
				+ "         http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd\"\n" + "         version=\"3.1\">\n";
		String footer = "\n" + "</web-app>";
		String jdbc = "\n<resource-ref>\n"
				+ "<description>BenchmarkDBDatasource</description>\n"
				+ "<res-ref-name>jdbc/BenchmarkDB</res-ref-name>\n"
				+ "<res-type>javax.sql.DataSource</res-type>\n"
				+ "<res-auth>Container</res-auth>\n"
				+ "</resource-ref>\n";
		PrintWriter writer = new PrintWriter("../WebRoot/WEB-INF/web.xml");
		writer.write(header);
		writer.write(jdbc);
		File basePath = new File("../WebRoot/WEB-INF/classes/").getCanonicalFile();
		URLClassLoader urlClassLoader = URLClassLoader.newInstance(new URL[] { basePath.toURL() });
		Collection<File> f = FileUtils.listFiles(basePath, TrueFileFilter.INSTANCE, TrueFileFilter.INSTANCE);
		for (File r : f) {
			if (r.getName().endsWith(".class")) {
				String p = r.getCanonicalPath().substring(basePath.getPath().length());
				if (p.startsWith(File.separator))
					p = p.substring(1);
				p = p.substring(0, p.length() - 6).replace(File.separatorChar, '.');
				Class<?> servlet = urlClassLoader.loadClass(p);
				if (HttpServlet.class.isAssignableFrom(servlet)) {
					
					String name = p;
					String url = "/" + name;
					WebServlet s = servlet.getAnnotation(WebServlet.class);
					if (s != null && s.value().length == 1) {
						url = s.value()[0];
					}
					writer.write("    <servlet>\n" + "        <servlet-name>" + name + "</servlet-name>\n"
							+ "        <servlet-class>" + p + "</servlet-class>\n" + "    </servlet>\n"
							+ "    <servlet-mapping>\n" + "        <servlet-name>" + name + "</servlet-name>\n"
							+ "        <url-pattern>" + url + "</url-pattern>\n" + "    </servlet-mapping>\n");
				}
			}
		}
		writer.write(footer);
		writer.close();

	}
}
