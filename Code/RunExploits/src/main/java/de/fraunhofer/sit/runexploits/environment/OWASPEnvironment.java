package de.fraunhofer.sit.runexploits.environment;

import java.net.Socket;
import java.security.Security;
import java.sql.SQLException;
import java.util.Map;
import java.util.Properties;

import javax.naming.InitialContext;
import javax.naming.NamingException;

import org.apache.commons.dbcp.BasicDataSource;
import org.bouncycastle.jce.provider.BouncyCastleProvider;

import de.fraunhofer.sit.specifications.environment.Database;


public class OWASPEnvironment {
	
	public BasicDataSource database;
	
	public OWASPEnvironment() {
		
		
		new Throwable("\"starting owasp environment...\"").printStackTrace(System.out);
		Properties props = System.getProperties();
        props.setProperty("java.naming.factory.initial","de.fraunhofer.sit.runexploits.environment.DummyInitialContext");

		database = new BasicDataSource();
		database.setDriverClassName("org.hsqldb.jdbcDriver");
        database.setUrl("jdbc:hsqldb:hsql://localhost/benchmarkDataBase;file:benchmark.db;sql.enforce_size=false;shutdown=false;");
        database.setUsername("sa");
        database.setPassword("");
		
        try {
            InitialContext ctx = new InitialContext();
            
            ctx.createSubcontext("jdbc");
			ctx.bind("jdbc/BenchmarkDB", database);
			ctx.bind("java:comp/env/jdbc/BenchmarkDB", database);
			
		} catch (NamingException e1) {
			throw new RuntimeException(e1);
		}
		new Thread(new Runnable() {
			
			@Override
			public void run() { 
				Properties props = System.getProperties();
		        props.setProperty("java.version", "1.8.0");
				try {
					org.owasp.benchmark.helpers.LDAPServer.main(new String[] {});
				} catch (Exception e) {
					throw new RuntimeException(e);
				}
			}
		}).start();
		new Thread(new Runnable() {
			
			@Override
			public void run() {
				try {
					String[] args = new String[] {"--database.0", "file:target/db/benchmark.db", "--dbname.0", "benchmarkDataBase"};
					
					org.hsqldb.Server.main(args);
				} catch (Exception e) {
					throw new RuntimeException(e);
				}
			}
		}, "HSQLDB").start();
		new Thread(new Runnable() {
	
			@Override
			public void run() {
				try {
					org.owasp.benchmark.helpers.DataBaseServer.main(new String[] {});
					// init database
					Class<?> helper = Class.forName("org.owasp.benchmark.helpers.DatabaseHelper");
				} catch (Exception e) {
					throw new RuntimeException(e);
				}
			}
		}).start();
		
	}
}
